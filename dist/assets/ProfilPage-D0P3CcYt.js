import{f as Ke,u as Ge,r as l,j as e,I as Fe,a as k,M as He,N as Ue,O as le,k as b,m as S,c as oe,E as ie,D as c,p as d,q as re,F as Ye,G as qe,d as u,P as ce,Q as de,S as he,T as ue,U as Qe,e as We,h as v}from"./index-DScGTkQE.js";import{h as E,E as M}from"./api-BPEy0ugj.js";import{u as Xe}from"./useEffectOnce-CxcMp374.js";import{P as Je,g as me}from"./PhoneInput-wFrj9W-I.js";function Ze(){try{localStorage.removeItem("bezmialem_auth"),Ke(),localStorage.removeItem("OTP_CONTEXT")}catch{}}async function es(P=!0){Ze(),P&&typeof window<"u"&&(window.location.href="/login")}const ys=({onLogout:P})=>{var X,J,Z,ee,se,ne,te,ae;const pe=Ge(),[ss,ns]=l.useState(!1),[fe,j]=l.useState(!1),[xe,g]=l.useState(!1),[ts,as]=l.useState(""),[ls,os]=l.useState(""),[is,rs]=l.useState(""),[C,T]=l.useState(""),[I,O]=l.useState("+90"),[je,z]=l.useState("TR"),[ge,R]=l.useState(""),[L,ye]=l.useState("phone"),[w,A]=l.useState(Array(6).fill("")),f=l.useRef([]),[y,$]=l.useState(""),[Ne,V]=l.useState(""),[B,_e]=l.useState("email"),[D,K]=l.useState(Array(6).fill("")),x=l.useRef([]),[be,h]=l.useState(!1),[Se,m]=l.useState(""),[Pe,p]=l.useState("success"),[cs,ds]=l.useState(!1),[G,F]=l.useState(!1),[hs,us]=l.useState(!1),[Ce,H]=l.useState(!1),[ms,ps]=l.useState(!1),[a,Ie]=l.useState(null),[r,we]=l.useState(null);function U(n){if(!n)return"";const s=n.replace(/\D/g,"");return s.startsWith("90")&&s.length===12?`+${s.slice(0,2)} ${s.slice(2,5)} ${s.slice(5,8)} ${s.slice(8)}`:s.length>4?`+${s.slice(0,2)} ${s.slice(2)}`:s}function De(n){return n?n.replace(/\D/g,"").replace(/(.{4})/g,"$1 ").trim():""}function ke(n){if(!n)return"";const s=new Date(n);return Number.isNaN(s.getTime())?"":s.toLocaleDateString("tr-TR")}Xe(()=>{(async()=>{var n,s;try{const t=await E.post(M.LOGIN,v({}),{retryMeta:{retry:1}});Ie((t==null?void 0:t.patient)||null),we((t==null?void 0:t.summary)||null);const o=U((n=t==null?void 0:t.patient)==null?void 0:n.phone_number);R(o),V(((s=t==null?void 0:t.patient)==null?void 0:s.email)||"")}catch{pe.replace("/login")}})()});const ve=((X=r==null?void 0:r.monthly_total_transactions)==null?void 0:X.reduce((n,s)=>n+((s==null?void 0:s.transaction_count)||0),0))||0,Ee=((Z=(J=r==null?void 0:r.monthly_total_transactions)==null?void 0:J.slice(-1)[0])==null?void 0:Z.transaction_count)||0,Y=((se=(ee=r==null?void 0:r.kpis)==null?void 0:ee.remaining_balance)==null?void 0:se.current)??((te=(ne=r==null?void 0:r.monthly_balance)==null?void 0:ne.slice(-1)[0])==null?void 0:te.balance),q=((ae=r==null?void 0:r.active_discounts_details)==null?void 0:ae.length)||0,Q=ge||U(a==null?void 0:a.phone_number),W=Ne||(a==null?void 0:a.email)||"",Me=async()=>{var s,t,o;if(G)return;if(!C){m("Lütfen telefon numaranızı giriniz."),p("danger"),h(!0);return}const n=C.replace(/\D/g,"");if(n.length<6||n.length>15){m("Telefon numarası 6-15 haneli olmalıdır."),p("danger"),h(!0);return}try{F(!0);const i=`${I.replace("+","")}${n}`,Be=((s=me(I))==null?void 0:s.iso2)||je;await E.post(M.UPDATE_PROFILE,v({new_phone_number:i,country_iso2:Be})),R(i),m("Telefonunuz güncellendi."),p("success"),h(!0),j(!1),N()}catch(i){m(((o=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:o.message)||(i==null?void 0:i.message)||"Telefon güncelleme isteği başarısız."),p("danger"),h(!0)}finally{F(!1)}},Te=(n,s)=>{var i;const t=s.replace(/\D/g,"").slice(0,1),o=[...w];o[n]=t,A(o),t&&n<f.current.length-1&&((i=f.current[n+1])==null||i.focus())},Oe=(n,s)=>{var t,o,i;s.key==="Backspace"&&!w[n]&&n>0&&((t=f.current[n-1])==null||t.focus()),s.key==="ArrowLeft"&&n>0&&((o=f.current[n-1])==null||o.focus()),s.key==="ArrowRight"&&n<f.current.length-1&&((i=f.current[n+1])==null||i.focus())},ze=async()=>{},N=()=>{ye("phone"),A(Array(6).fill("")),T(""),O("+90"),z("TR")},Re=async()=>{var s,t;if(Ce)return;if(!y){m("Lütfen e-posta adresinizi giriniz."),p("danger"),h(!0);return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(y)){m("Geçerli bir e-posta adresi giriniz."),p("danger"),h(!0);return}try{H(!0),await E.post(M.UPDATE_PROFILE,v({email:y})),V(y),m("E-posta adresiniz güncellendi."),p("success"),h(!0),g(!1),_()}catch(o){m(((t=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:t.message)||(o==null?void 0:o.message)||"E-posta güncelleme isteği başarısız."),p("danger"),h(!0)}H(!1)},Le=(n,s)=>{var i;const t=s.replace(/\D/g,"").slice(0,1),o=[...D];o[n]=t,K(o),t&&n<x.current.length-1&&((i=x.current[n+1])==null||i.focus())},Ae=(n,s)=>{var t,o,i;s.key==="Backspace"&&!D[n]&&n>0&&((t=x.current[n-1])==null||t.focus()),s.key==="ArrowLeft"&&n>0&&((o=x.current[n-1])==null||o.focus()),s.key==="ArrowRight"&&n<x.current.length-1&&((i=x.current[n+1])==null||i.focus())},$e=async()=>{},_=()=>{_e("email"),K(Array(6).fill("")),$("")},Ve=async()=>{await es(!0),P()};return e.jsx(Fe,{children:e.jsxs(k,{className:"ion-padding profil-page",children:[e.jsx(He,{className:"stats-grid",children:e.jsxs(Ue,{children:[e.jsx(le,{size:"6",children:e.jsx(b,{className:"stat-card",children:e.jsxs(S,{children:[e.jsx("div",{className:"stat-value",children:ve.toLocaleString("tr-TR")}),e.jsx("div",{className:"stat-label",children:"Toplam İşlem"})]})})}),e.jsx(le,{size:"6",children:e.jsx(b,{className:"stat-card",children:e.jsxs(S,{children:[e.jsx("div",{className:"stat-value",children:Ee.toLocaleString("tr-TR")}),e.jsx("div",{className:"stat-label",children:"Bu Ay"})]})})})]})}),e.jsxs("div",{className:"section",children:[e.jsx(oe,{children:e.jsx("h3",{className:"section-title",children:"Kişisel Bilgiler"})}),e.jsx(b,{children:e.jsx(S,{children:e.jsxs(ie,{lines:"none",children:[e.jsx(c,{children:e.jsxs(d,{children:[e.jsx("p",{className:"info-label",children:"Ad Soyad"}),e.jsx("h3",{className:"info-value",children:a?`${a.first_name} ${a.last_name}`:"-"})]})}),e.jsx(c,{children:e.jsxs(d,{children:[e.jsx("p",{className:"info-label",children:"T.C. Kimlik No"}),e.jsx("h3",{className:"info-value",children:(a==null?void 0:a.tc_identity_no)||"-"})]})}),(a==null?void 0:a.card_number)&&e.jsx(c,{children:e.jsxs(d,{children:[e.jsx("p",{className:"info-label",children:"Kart Numarası"}),e.jsx("h3",{className:"info-value",children:De(a.card_number)})]})}),Q&&e.jsx(c,{children:e.jsxs(d,{children:[e.jsx("p",{className:"info-label",children:"Telefon"}),e.jsx("h3",{className:"info-value",children:Q})]})}),W&&e.jsx(c,{children:e.jsxs(d,{children:[e.jsx("p",{className:"info-label",children:"E-posta"}),e.jsx("h3",{className:"info-value",children:W})]})}),(a==null?void 0:a.birth_date)&&e.jsx(c,{children:e.jsxs(d,{children:[e.jsx("p",{className:"info-label",children:"Doğum Tarihi"}),e.jsx("h3",{className:"info-value",children:ke(a.birth_date)})]})}),((a==null?void 0:a.city)||(a==null?void 0:a.district))&&e.jsx(c,{children:e.jsxs(d,{children:[e.jsx("p",{className:"info-label",children:"İl / İlçe"}),e.jsx("h3",{className:"info-value",children:[a==null?void 0:a.city,a==null?void 0:a.district].filter(Boolean).join(" / ")})]})}),(a==null?void 0:a.address)&&e.jsx(c,{children:e.jsxs(d,{children:[e.jsx("p",{className:"info-label",children:"Adres"}),e.jsx("h3",{className:"info-value",children:a.address})]})}),typeof Y=="number"&&e.jsx(c,{children:e.jsxs(d,{children:[e.jsx("p",{className:"info-label",children:"Kalan Bakiye"}),e.jsx("h3",{className:"info-value",children:Y.toLocaleString("tr-TR",{style:"currency",currency:"TRY"})})]})}),q>0&&e.jsx(c,{children:e.jsxs(d,{children:[e.jsx("p",{className:"info-label",children:"Aktif İndirim"}),e.jsx("h3",{className:"info-value",children:q})]})})]})})})]}),e.jsxs("div",{className:"section",children:[e.jsx(oe,{children:e.jsx("h3",{className:"section-title",children:"Hesap Ayarları"})}),e.jsx(b,{children:e.jsx(S,{children:e.jsxs(ie,{lines:"full",children:[e.jsxs(c,{button:!0,detail:!0,onClick:()=>j(!0),children:[e.jsx(re,{slot:"start",icon:Ye}),e.jsx(d,{children:"Telefon Değiştir"})]}),e.jsxs(c,{button:!0,detail:!0,onClick:()=>g(!0),children:[e.jsx(re,{slot:"start",icon:qe}),e.jsx(d,{children:"E-posta Değiştir"})]})]})})})]}),e.jsx(u,{expand:"block",fill:"outline",color:"danger",onClick:Ve,className:"logout-button",children:"Çıkış Yap"}),e.jsxs(ce,{isOpen:fe,onDidDismiss:()=>{j(!1),N()},children:[e.jsx(de,{children:e.jsx(he,{children:e.jsx(ue,{children:"Telefon Değiştir"})})}),e.jsxs(k,{className:"ion-padding phoneModal__content",children:[L==="phone"&&e.jsxs("div",{className:"phoneModal__step phoneModal__stepPhone",children:[e.jsx(Je,{phoneNumber:C,countryCode:I,onPhoneChange:T,onCountryCodeChange:n=>{O(n);const s=me(n);s!=null&&s.iso2&&z(s.iso2)},placeholder:"Telefon numarası",maxLength:10,disabled:G}),e.jsx(u,{expand:"block",className:"primary-button",onClick:Me,children:"Devam Et"}),e.jsx(u,{expand:"block",fill:"clear",onClick:()=>{j(!1),N()},children:"Vazgeç"})]}),L==="otp"&&e.jsxs("div",{className:"phoneModal__step phoneModal__stepOtp",children:[e.jsx("p",{className:"phoneModal__instruction",children:"SMS ile gönderilen 6 haneli kodu giriniz."}),e.jsx("div",{className:"phoneModal__otpInputs",children:w.map((n,s)=>e.jsx("input",{ref:t=>{t&&(f.current[s]=t)},inputMode:"numeric",pattern:"[0-9]*",maxLength:1,className:"phoneModal__otpInput",value:n,onChange:t=>Te(s,t.target.value),onKeyDown:t=>Oe(s,t)},s))}),e.jsx(u,{expand:"block",className:"primary-button",onClick:ze,children:"Doğrula ve Güncelle"}),e.jsx(u,{expand:"block",fill:"clear",onClick:()=>{j(!1),N()},children:"Vazgeç"})]})]})]}),e.jsxs(ce,{isOpen:xe,onDidDismiss:()=>{g(!1),_()},children:[e.jsx(de,{children:e.jsx(he,{children:e.jsx(ue,{children:"E-posta Değiştir"})})}),e.jsxs(k,{className:"ion-padding phoneModal__content",children:[B==="email"&&e.jsxs("div",{className:"phoneModal__step phoneModal__stepPhone",children:[e.jsx(Qe,{label:"Yeni E-posta",labelPlacement:"stacked",type:"email",value:y,onIonInput:n=>$(n.detail.value||""),className:"custom-input",placeholder:"ornek@eposta.com"}),e.jsx(u,{expand:"block",className:"primary-button",onClick:Re,children:"Devam Et"}),e.jsx(u,{expand:"block",fill:"clear",onClick:()=>{g(!1),_()},children:"Vazgeç"})]}),B==="otp"&&e.jsxs("div",{className:"phoneModal__step phoneModal__stepOtp",children:[e.jsx("p",{className:"phoneModal__instruction",children:"E-posta adresinize gönderilen 6 haneli kodu giriniz."}),e.jsx("div",{className:"phoneModal__otpInputs",children:D.map((n,s)=>e.jsx("input",{ref:t=>{t&&(x.current[s]=t)},inputMode:"numeric",pattern:"[0-9]*",maxLength:1,className:"phoneModal__otpInput",value:n,onChange:t=>Le(s,t.target.value),onKeyDown:t=>Ae(s,t)},s))}),e.jsx(u,{expand:"block",className:"primary-button",onClick:$e,children:"Doğrula ve Güncelle"}),e.jsx(u,{expand:"block",fill:"clear",onClick:()=>{g(!1),_()},children:"Vazgeç"})]})]})]}),e.jsx(We,{isOpen:be,onDidDismiss:()=>h(!1),message:Se,duration:2500,position:"top",color:Pe})]})})};export{ys as default};
